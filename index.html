<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR ì½”ë“œ ì¸ì¦ ì‹œìŠ¤í…œ</title>
    <style>
        body {
            text-align: center;
            font-family: Arial, sans-serif;
        }
        video {
            width: 100%;
            max-width: 800px; /* í™”ë©´ í¬ê¸° ì¡°ì ˆ ê°€ëŠ¥ */
            border: 2px solid black;
        }
        #cameraSelect {
            margin: 10px;
            padding: 5px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <h1>QR ì½”ë“œ ì¸ì¦ ì‹œìŠ¤í…œ</h1>
    
    <!-- ì¹´ë©”ë¼ ì„ íƒ -->
    <label for="cameraSelect">ì¹´ë©”ë¼ ì„ íƒ:</label>
    <select id="cameraSelect"></select>

    <!-- ì¹´ë©”ë¼ í™”ë©´ -->
    <video id="video" autoplay></video>
    <canvas id="canvas" hidden></canvas>
    <audio id="audio"></audio>

    <script src="https://cdn.jsdelivr.net/npm/jsqr"></script>
    <script>
        const audioFiles = {
            "130525130525": "audio/admin.mp3",  // ê´€ë¦¬ì
            "740630": "audio/guest.mp3",       // ê²ŒìŠ¤íŠ¸
            "800215": "audio/mom.mp3",         // ì—„ë§ˆ
            "150916": "audio/yoon.mp3"         // ì„ì‹œìœ¤
        };

        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        const audioPlayer = document.getElementById("audio");
        const cameraSelect = document.getElementById("cameraSelect");

        let currentStream = null;

        // ğŸ“Œ ì‚¬ìš© ê°€ëŠ¥í•œ ì¹´ë©”ë¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        async function getCameras() {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === "videoinput");

            cameraSelect.innerHTML = ""; // ê¸°ì¡´ ì˜µì…˜ ì‚­ì œ

            videoDevices.forEach((device, index) => {
                const option = document.createElement("option");
                option.value = device.deviceId;
                option.text = device.label || `ì¹´ë©”ë¼ ${index + 1}`;
                cameraSelect.appendChild(option);
            });

            if (videoDevices.length > 0) {
                startCamera(videoDevices[0].deviceId); // ì²« ë²ˆì§¸ ì¹´ë©”ë¼ ê¸°ë³¸ ì„ íƒ
            }
        }

        // ğŸ“Œ ì„ íƒí•œ ì¹´ë©”ë¼ ì‹¤í–‰
        async function startCamera(deviceId) {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop()); // ê¸°ì¡´ ìŠ¤íŠ¸ë¦¼ ì¤‘ì§€
            }

            const constraints = {
                video: { 
                    deviceId: { exact: deviceId }, 
                    width: { ideal: 1920 }, 
                    height: { ideal: 1080 } 
                }
            };

            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            currentStream = stream;
        }

        // ğŸ“Œ QR ì½”ë“œ ìŠ¤ìº”
        function scanQRCode() {
            setInterval(() => {
                if (!video.videoWidth) return;

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);

                if (code) {
                    const qrData = code.data;
                    console.log("QR ì½”ë“œ ì¸ì‹ë¨:", qrData);

                    if (audioFiles[qrData]) {
                        audioPlayer.src = audioFiles[qrData];
                        audioPlayer.play();
                    } else {
                        alert("ë“±ë¡ë˜ì§€ ì•Šì€ QR ì½”ë“œì…ë‹ˆë‹¤.");
                    }
                }
            }, 1000);
        }

        // ğŸ“Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        cameraSelect.addEventListener("change", (event) => {
            startCamera(event.target.value);
        });

        // ğŸ“Œ ì‹¤í–‰
        getCameras();
        scanQRCode();
    </script>
</body>
</html>
